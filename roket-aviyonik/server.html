<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Seri Port ile Roket Döndürme</title>
  <style>
    /* Önceki stil aynı kalabilir */
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial; background: #121212; color: #eee; }
    #container { display: flex; height: 100vh; }
    #left, #right { flex: 1; padding: 20px; box-sizing: border-box; }
    #left { background: #1e1e1e; display: flex; justify-content: center; align-items: center; }
    #right { background: #282828; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #444; }
    th { background: #444; }
    tr:hover { background: #555; }
    button {
      padding: 10px 20px;
      margin-bottom: 20px;
      background: #444;
      color: #eee;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 5px;
    }
    button:hover { background: #666; }
    canvas { width: 100% !important; height: 100% !important; display: block; }
  </style>
</head>
<body>

<div id="container">
  <div id="left">
    <!-- Three.js canvas buraya gelecek -->
  </div>
  <div id="right">
    <button id="connectBtn">Seri Porta Bağlan</button>
    <table>
      <thead>
        <tr><th>Veri Türü</th><th>Değer</th></tr>
      </thead>
      <tbody>
        <tr><td>Basınç</td><td id="basinc">-</td></tr>
        <tr><td>X</td><td id="x">-</td></tr>
        <tr><td>Y</td><td id="y">-</td></tr>
        <tr><td>Z</td><td id="z">-</td></tr>
        <tr><td>Sıcaklık</td><td id="sicaklik">-</td></tr>
        <tr><td>Nem</td><td id="nem">-</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
  const leftDiv = document.getElementById('left');

  // Three.js setup
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, leftDiv.clientWidth / leftDiv.clientHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(leftDiv.clientWidth, leftDiv.clientHeight);
  leftDiv.appendChild(renderer.domElement);

  // Light
  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(5, 10, 7);
  scene.add(dirLight);
  scene.add(new THREE.AmbientLight(0x404040));

  // Rocket model
  const geometry = new THREE.CylinderGeometry(0.3, 0.3, 4, 32);
  const material = new THREE.MeshStandardMaterial({ color: 0xff4444 });
  const rocket = new THREE.Mesh(geometry, material,);
  scene.add(rocket);

  camera.position.z = 5;

  window.addEventListener('resize', () => {
    camera.aspect = leftDiv.clientWidth / leftDiv.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(leftDiv.clientWidth, leftDiv.clientHeight);
  });

  // Table cells
  const basincCell = document.getElementById('basinc');
  const xCell = document.getElementById('x');
  const yCell = document.getElementById('y');
  const zCell = document.getElementById('z');
  const sicaklikCells = document.getElementById('sicaklik')
  const nemCells = document.getElementById('nem')
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  // Seri portla bağlantı ve veri okuma
  const connectBtn = document.getElementById('connectBtn');
  let port;
  let reader;

  connectBtn.addEventListener('click', async () => {
    if ('serial' in navigator) {
      try {
        // Kullanıcıdan port seçmesini iste
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        const decoder = new TextDecoderStream();
        const inputDone = port.readable.pipeTo(decoder.writable);
        const inputStream = decoder.readable;
        reader = inputStream.getReader();

        // Sürekli veri oku
        while (true) {
          const { value, done } = await reader.read();
          if (done) {
            reader.releaseLock();
            break;
          }
          if (value) {
            parseData(value);
          }
        }

      } catch (error) {
        alert('Seri port bağlantısı başarısız: ' + error);
      }
    } else {
      alert('Bu tarayıcıda Web Serial API desteklenmiyor.');
    }
  });

  // Seri porttan gelen veri örneği:
  // basinc:1013.2;x:0.5;y:1.2;z:0.8;

  function parseData(data) {
    // Gelen veriyi satırlara böl (bazı cihazlar satır satır gönderir)
    const lines = data.split('\n');
    lines.forEach(line => {
      line = line.trim();
      if (!line) return;

      // Örnek: basinc:1013.2;x:0.5;y:1.2;z:0.8;
      const pairs = line.split(';').filter(Boolean); // boş olanları çıkar
      const dataObj = {};
      pairs.forEach(pair => {
        const [key, val] = pair.split(':');
        if (key && val) {
          dataObj[key.toLowerCase()] = parseFloat(val);
        }
      });

      if ('basinc' in dataObj) basincCell.textContent = dataObj.basinc.toFixed(2);
      if ('sicaklik' in dataObj) sicaklikCells.textContent = dataObj.sicaklik.toFixed(2);
      if ('nem' in dataObj) nemCells.textContent = dataObj.nem.toFixed(2);
      if ('x' in dataObj) {
        rocket.rotation.x = dataObj.x;
        xCell.textContent = dataObj.x.toFixed(2);
      }
      if ('y' in dataObj) {
        rocket.rotation.y = dataObj.y;
        yCell.textContent = dataObj.y.toFixed(2);
      }
      if ('z' in dataObj) {
        rocket.rotation.z = dataObj.z;
        zCell.textContent = dataObj.z.toFixed(2);
      }
    });
  }
</script>

</body>
</html>
